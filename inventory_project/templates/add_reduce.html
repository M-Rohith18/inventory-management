{% extends "base.html" %}
{% block content %}
{% include "includes/header.html" %}

<section class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-7 col-lg-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-primary text-white rounded-top-4">
          <h4 class="mb-0 text-center py-2">Add / Reduce Stock</h4>
        </div>
        <div class="card-body p-4">
          <form id="stockForm">
            <div class="mb-3">
              <label for="item" class="form-label">Select Item</label>
              <select id="item" class="form-control" name="item">
                <option value="">-- Choose Item --</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="type" class="form-label">Transaction Type</label>
              <select id="type" class="form-control" name="type">
                <option value="">-- Choose Type --</option>
                <option value="IN">Add</option>
                <option value="OUT">Reduce</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="quantity" class="form-label">Quantity</label>
              <input type="number" id="quantity" name="quantity" class="form-control" placeholder="Enter quantity">
            </div>

            <div class="mb-3">
              <label for="notes" class="form-label">Notes (Optional)</label>
              <textarea id="notes" name="notes" class="form-control" rows="3"></textarea>
            </div>

            <button type="submit" class="btn btn-primary w-100">Submit</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- jQuery CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const token = localStorage.getItem("access");

  if (!token) {
    alert("You must be logged in.");
    window.location.href = "login";
  }

  $(document).ready(function () {
    // Load items
    $.ajax({
      url: '/api/item/',
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      success: function (items) {
        items.forEach(item => {
          $('#item').append(
            $('<option>', {
              value: item.id,
              text: item.name + ' (Stock: ' + item.current_stock + ')'
            })
          );
        });
      },
      error: function () {
        alert('Error loading items.');
        window.location.href = "/login";
      }
    });

    // Submit form
    $('#stockForm').submit(function (e) {
      e.preventDefault();

      const payload = {
        item: $('#item').val(),
        type: $('#type').val(),
        quantity: $('#quantity').val(),
        notes: $('#notes').val()
      };

      $.ajax({
        url: '/api/stock-add-reduce/',
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        data: JSON.stringify(payload),
        success: function () {
          alert('Stock updated successfully!');
          $('#stockForm')[0].reset();
        },
        error: function (xhr) {
          alert(xhr.responseJSON.detail || 'Something went wrong');
        }
      });
    });
  });
</script>
{% endblock %}
