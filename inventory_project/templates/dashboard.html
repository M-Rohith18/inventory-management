{% extends 'base.html' %}
{% block content %}
{% include "includes/header.html" %}
{% load static %}

<div class="container col-md-11 mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0" style="font-family: Georgia, serif;">Inventory Item List</h2>
  </div>

  <!-- Filters Row (1 line) -->
  <div class="row g-3 align-items-end mb-4">
    <div class="col-md-2">
      <label for="category" class="form-label">Category</label>
      <select id="category" class="form-select">
        <option value="">-- All --</option>
      </select>
    </div>

    <div class="col-md-3">
      <label for="search-item" class="form-label">Search Item</label>
      <input type="text" id="search-item" class="form-control" placeholder="Enter item name">
    </div>

    <div class="col-md-3">
      <label class="form-label">Upload CSV</label>
      <div class="d-flex">
        <input type="file" id="upload-file" accept=".csv" class="form-control me-2">
        <button id="upload-btn" class="btn btn-warning">Upload</button>
      </div>
    </div>

    <div class="col-md-2">
      <label class="form-label">Sample CSV</label>
      <a href="{% static 'inventory_export.csv' %}" class="btn btn-danger w-100" download>Sample</a>
    </div>

    <div class="col-md-2">
      <label class="form-label">Export</label>
      <button id="download-btn" class="btn btn-primary w-100">Download</button>
    </div>
  </div>

  <!-- Items Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Category</th>
          <th>Item Name</th>
          <th>Current Stock</th>
        </tr>
      </thead>
      <tbody id="item-table-body">
        <tr><td colspan="3">Loading items...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-center mt-3" id="pagination-container"></div>
</div>

<!-- âœ… Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  const token = localStorage.getItem('access');
  if (!token) {
    alert('You must be logged in.');
    window.location.href = "/login/";
  }

  let currentPage = 1;
  let totalPages = 1;

  $(document).ready(function () {
    // Load categories
    $.ajax({
      url: '/api/categories/',
      method: 'GET',
      headers: { 'Authorization': 'Bearer ' + token },
      success: function (data) {
        data.forEach(category => {
          $('#category').append(`<option value="${category.id}">${category.name}</option>`);
        });
      }
    });

    // Fetch filtered items
    function fetchItems(page = 1) {
      currentPage = page;
      const filters = {
        category_id: $('#category').val(),
        item_name: $('#search-item').val().trim(),
        page: currentPage
      };

      $.ajax({
        url: '/api/items/',
        method: 'GET',
        headers: { 'Authorization': 'Bearer ' + token },
        data: filters,
        success: function (res) {
          renderTable(res.results || []);
          renderPagination(res.count);
        },
        error: function () {
          $('#item-table-body').html('<tr><td colspan="3">Error loading items.</td></tr>');
        }
      });
    }

    // Render table
    function renderTable(items) {
      const tbody = $('#item-table-body');
      tbody.empty();

      if (items.length === 0) {
        tbody.append('<tr><td colspan="3">No items found.</td></tr>');
      } else {
        items.forEach(item => {
          tbody.append(`
            <tr>
              <td>${item.category_name}</td>
              <td>${item.name}</td>
              <td>${item.current_stock}</td>
            </tr>
          `);
        });
      }
    }

    // Render pagination
    function renderPagination(count, pageSize = 25) {
      totalPages = Math.ceil(count / pageSize);
      const container = $('#pagination-container');
      container.empty();

      if (totalPages <= 1) return;

      let html = `<nav><ul class="pagination">`;

      html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>`;

      for (let i = 1; i <= totalPages; i++) {
        html += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${i}">${i}</a>
          </li>`;
      }

      html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>`;

      html += `</ul></nav>`;
      container.html(html);
    }

    // Pagination click
    $(document).on('click', '.page-link', function (e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      if (!isNaN(page) && page >= 1 && page <= totalPages) {
        fetchItems(page);
      }
    });

    // Event bindings
    $('#category').on('change', () => fetchItems(1));
    $('#search-item').on('input', function () {
      clearTimeout($.data(this, 'timer'));
      const wait = setTimeout(() => fetchItems(1), 300);
      $(this).data('timer', wait);
    });

    $('#download-btn').on('click', function () {
      const categoryId = $('#category').val();
      const itemName = $('#search-item').val().trim();
      let url = `/api/download-all/?token=${token}`;

      if (categoryId) url += `&category_id=${categoryId}`;
      if (itemName) url += `&item_name=${encodeURIComponent(itemName)}`;

      window.open(url, '_blank');
    });

    $('#upload-btn').on('click', function () {
      const file = $('#upload-file')[0].files[0];
      if (!file) return alert("Please choose a CSV file.");

      const formData = new FormData();
      formData.append('file', file);

      $.ajax({
        url: '/api/upload-inventory/',
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        data: formData,
        processData: false,
        contentType: false,
        success: function () {
          alert("Upload successful!");
          fetchItems(currentPage);
        },
        error: function () {
          alert("Upload failed.");
        }
      });
    });

    // Initial load
    fetchItems();
  });
</script>

{% endblock %}
