{% extends "base.html" %}
{% block content %}
{% include "includes/header.html" %}

<section class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-7 col-lg-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-gradient bg-primary text-white rounded-top-4">
          <h4 class="mb-0 text-center py-2">Add New Inventory Item</h4>
        </div>
        <div class="card-body p-4">

          <form id="addItemForm" novalidate>
            <!-- Item Name -->
            <div class="mb-3">
              <label for="itemName" class="form-label">Item Name</label>
              <input type="text" class="form-control" id="itemName" name="name" placeholder="Enter Item Name">
            </div>

            <!-- Category -->
            <div class="mb-3">
              <label for="itemCategory" class="form-label">Category</label>
              <select id="itemCategory" class="form-control" name="category_id">
                <option value="">Select a category</option>
              </select>
            </div>

            <!-- Unit -->
            <div class="mb-3">
              <label for="itemUnit" class="form-label">Unit</label>
              <input type="text" class="form-control" id="itemUnit" name="unit" placeholder="e.g., pcs">
            </div>

            <!-- Description -->
            <div class="mb-3">
              <label for="itemDescription" class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="itemDescription" name="description" rows="3"></textarea>
            </div>

            <!-- Current Stock -->
            <div class="mb-4">
              <label for="current_stock" class="form-label">Current Stock</label>
              <input type="number" class="form-control" id="current_stock" name="current_stock">
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary w-100 py-2">
              <i class="bi bi-plus-circle me-1"></i> Add Item
            </button>
          </form>

        </div>
      </div>
    </div>
  </div>
</section>

<!-- jQuery and Script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const token = localStorage.getItem("access");

  if (!token) {
    alert("You must be logged in.");
    window.location.href = "/login";
  }

  $(document).ready(function () {
    // Load categories
    $.ajax({
      url: "/api/categories/",
      method: "GET",
      headers: {
        Authorization: "Bearer " + token,
      },
      success: function (data) {
        data.forEach(function (cat) {
          $("#itemCategory").append(
            $("<option>", { value: cat.id, text: cat.name })
          );
        });
      },
      error: function () {
        alert("Could not load categories.");
      },
    });

    // Submit form
    $("#addItemForm").on("submit", function (e) {
      e.preventDefault();

      const payload = {
        name: $("#itemName").val(),
        category_id: $("#itemCategory").val(),
        unit: $("#itemUnit").val(),
        description: $("#itemDescription").val(),
        current_stock: $("#current_stock").val()
      };

      $.ajax({
        url: "/api/add-item/",
        method: "POST",
        headers: {
          Authorization: "Bearer " + token,
          "Content-Type": "application/json",
        },
        data: JSON.stringify(payload),
        success: function () {
          alert("Item added successfully!");
          $("#addItemForm")[0].reset();
        },
        error: function (xhr) {
          alert("Failed to add item: " + (xhr.responseJSON.detail || "Unknown error"));
        },
      });
    });
  });
</script>
{% endblock %}
